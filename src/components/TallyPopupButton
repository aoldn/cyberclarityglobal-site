// src/components/TallyPopupButton.tsx
import { useEffect, useState } from "react";

function ensureTallyScript(): Promise<void> {
  return new Promise((resolve) => {
    if ((window as any).Tally) return resolve();
    const exists = document.querySelector<HTMLScriptElement>('script[src="https://tally.so/widgets/embed.js"]');
    if (exists) {
      exists.addEventListener("load", () => resolve());
      return;
    }
    const s = document.createElement("script");
    s.src = "https://tally.so/widgets/embed.js";
    s.async = true;
    s.onload = () => resolve();
    document.body.appendChild(s);
  });
}

export default function TallyPopupButton() {
  const [ready, setReady] = useState(false);

  useEffect(() => {
    ensureTallyScript().then(() => setReady(true));
  }, []);

  const open = () => {
    (window as any).Tally?.openPopup("mDl82b", {
      layout: "modal", // "drawer-left" | "drawer-right" | "fullscreen"
      width: 700,
      hideTitle: true,
      transparentBackground: true,
    });
  };

  return (
    <button
      onClick={open}
      disabled={!ready}
      className="px-5 py-3 rounded-2xl shadow font-medium"
    >
      Start Free Assessment
    </button>
  );
}
